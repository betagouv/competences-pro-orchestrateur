---
- hosts: all

  vars:
    chemin_racine: "{{ ansible_env.HOME }}"
    chemin_client: "{{ chemin_racine }}/client"
    chemin_serveur: "{{ chemin_racine }}/serveur"
    chemin_orchestrateur: "{{ chemin_racine }}/orchestrateur"
    chemin_config: "{{ chemin_racine }}/config"
    version_orchestrateur: master
    version_serveur: master
    version_client: master
    hote_client: competences-pro.beta.gouv.fr
    hote_serveur: api.competences-pro.beta.gouv.fr
    docker_compose_environnement:
      CHEMIN_CLIENT: "{{ chemin_client }}"
      CHEMIN_SERVEUR: "{{ chemin_serveur }}"
      HOTE_SERVEUR: "{{ hote_serveur }}"
      HOTE_CLIENT: "{{ hote_client }}"
      RESEAU_TRAEFIK: "traefik"

  tasks:
    - name: Clone ou met à jour le dépot
      git:
        repo: "https://github.com/betagouv/{{ item.depot }}.git"
        version: "{{ item.version }}"
        dest: "{{ item.destination }}"
        force: yes
      loop:
        - destination: "{{ chemin_orchestrateur }}"
          depot: competences-pro-orchestrateur
          version: "{{ version_orchestrateur }}"

        - destination: "{{ chemin_serveur }}"
          depot: competences-pro-serveur
          version: "{{ version_serveur }}"

        - destination: "{{ chemin_client }}"
          depot: competences-pro
          version: "{{ version_client }}"

    - name: Copie le fichier d'environnement de production vers l'orchestrateur
      copy:
        remote_src: yes
        src: "{{ chemin_config }}/.env.serveur.prod"
        dest: "{{ chemin_orchestrateur }}/.env.serveur.prod"

    - name: Construis les images docker
      command: docker-compose build --pull
      args:
        chdir: "{{ chemin_orchestrateur }}"
      environment: "{{ docker_compose_environnement }}"

    - name: Lance les tâches de gestion de la base de données
      command: docker-compose run --rm serveur bundle exec rails db:migrate
      args:
        chdir: "{{ chemin_orchestrateur }}"
      environment: "{{ docker_compose_environnement }}"

    - name: Démarre les images
      command: docker-compose up -d
      args:
        chdir: "{{ chemin_orchestrateur }}"
      environment: "{{ docker_compose_environnement }}"
